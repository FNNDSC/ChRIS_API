<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


    <title>API Test Server</title>

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <style type="text/css">
        h3{
            margin:5px;
        }
        button{
            float:left;
        }

        h2:hover .overlay {
            display:block;
            background-color:white;
            opacity:0.75;
        }

        .formLayout
        {
            background-color: #f3f3f3;
            border: solid 1px #a1a1a1;
            padding: 10px;
            width: 880px;
            margin-left: auto;
            margin-right:auto;
        }

        .resultLayout
        {
            padding: 10px;
            width: 880px;
            margin-left: auto;
            margin-right:auto;
        }


        pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
        .string     { font-family:courier; color: green; }
        .number     { font-family:courier; color: darkorange; }
        .boolean    { font-family:courier; color: blue; }
        .null       { font-family:courier; color: magenta; }
        .key        { font-family:courier; color: red; }
 
        .input {
            font-family: courier;
        }

        .formLayout label
        {
            text-align: right;
            padding-right: 20px;
        }
     
        br
        {
            clear: left;
        }

        .onlythree {     
            width: 50px;    
            border: 0;    
        }    

        .modal {
            display:    none;
            position:   fixed;
            z-index:    1000;
            top:        0;
            left:       0;
            height:     100%;
            width:      100%;
            background: rgba( 255, 255, 255, .8 )
            url('http://i.stack.imgur.com/FhHRx.gif')
            50% 50%
            no-repeat;
        }

        /* When the body has the loading class, we turn
           the scrollbar off with overflow:hidden */
        body.loading {
            overflow: hidden;
        }

        /* Anytime the body has the loading class, our
           modal element will be visible */
        body.loading .modal {
            display: block;
        }

        .ui-widget.helpInfo-dialog {
            font-family:    Verdana,Arial,sans-serif;
            font-size:      .8em;
        }

        .ui-widget-content.helpInfo-dialog {
            background:     #F9F9F9;
            border:         1px solid #90d93f;
            color:          #222222;
        }

        .ui-dialog.helpInfo-dialog {
            left:           0;
            outline:        0 none;
            padding:        0 !important;
            position:       absolute;
            top:            0;
        }

        .ui-dialog.helpInfo-dialog .ui-dialog-content {
            background:     none repeat scroll 0 0 transparent;
            border:         0 none;
            overflow:       auto;
            position:       relative;
            padding:        20;
            margin:         0;
        }

        .ui-dialog.helpInfo-dialog .ui-widget-header {
            background:     #b0de78;
            border:         0;
            color:          #fff;
            font-weight:    normal;
        }

        .ui-dialog.helpInfo-dialog .ui-dialog-titlebar {
            padding:        0.1em .5em;
            position:       relative;
            font-size:      1em;
        }

    </style>

</head>

<body>
    <h2 class="formLayout">Interact with the ChRIS REST API</h2>

    <div class="formLayout">
        <style scoped>
            .button-xsmall {
                font-size: 70%;
            }

            .button-loginStatus-loggedIn,
            .button-loginStatus-loggedOut,
            .button-help {
                color: white;
                /*border-radius: 4px;*/
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            }

            .button-login {
                background: rgb(28, 184, 65); /* this is a green */
            }

            .button-logout {
                background: rgb(223, 117, 20); /* this is an orange */
            }

            .button-loginStatus-loggedOut {
                background: rgb(223, 117, 20); /* this is an orange */
            }

            .button-loginStatus-loggedIn {
                background: rgb(28, 184, 65); /* this is a green */
            }

            .button-jsonHighlight-on {
                background: rgb(28, 184, 65); /* this is a green */
            }

            .button-jsonHighlight-off {
                background: rgb(223, 117, 20); /* this is an orange */
            }

            .button-useFileDB-on {
                background: rgb(28, 184, 65); /* this is a green */
            }

            .button-useFileDB-off {
                background: rgb(223, 117, 20); /* this is an orange */
            }

            .button-createNewDB-on {
                background: rgb(28, 184, 65); /* this is a green */
            }

            .button-createNewDB-off {
                background: rgb(223, 117, 20); /* this is an orange */
            }

            .button-REST-delete {
                background: rgb(223, 27, 15); /* this is an orange */
            }

            .button-REST-run {
                background: rgb(223, 117, 20); /* this is an orange */
            }

            .button-help {
                background: rgb(66, 184, 221); /* this is a light blue */
                float: right;
            }

            .button-reset {
                background: rgb(223, 117, 20); /* this is an orange */
                display: inline-block;
                position: relative;
                left: 45%;
                /*float: right;*/
            }
        </style>
        <div>
            <button class="button-xsmall button-loginStatus-loggedOut pure-button"     id="loginStatus" onclick="loginStatus_toggle()">login status: unknown</button>
            <button onclick="jsonSyntaxHightlight_toggle()" class="button-xsmall pure-button pure-button-primary button-jsonHighlight-on" id="JSON_status">JSON syntax highlight: ON</button>
            <button onclick="useFileDB_toggle()" class="button-xsmall pure-button pure-button-primary button-useFileDB-on" id="useFileDB_status">Use file DB: ON</button>
            <button onclick="createNewDB_toggle()" class="button-xsmall pure-button pure-button-primary button-createNewDB-off" id="createNewDB_status">Create new DB: OFF</button>
            <button class="button-xsmall button-help   pure-button"     id="opener">help</button>
            <br>
        </div>
        <div id="helpInfo" title="help">
            <h3>Interacting with the ChRIS REST API backend</h3>
            <h4>Start the ChRIS REST API services</h4>
            <p>Make sure that the ChRIS REST Web Service has been started:</p>
            <p style="text-indent: 2.0em; border-color: #000;"><tt>./ChRIS_WS.py -i &lt;someIP&gt; -p &lt;somePort&gt; --API REST</tt></p>
            <h4>Start a Web Server in the checkout directory</h4>
            <p>The best way to run this interaction page is via a server (i.e. do not directly load this page into your browser using the <tt>file:///</tt> directive). Simply start a python web server in the repository check out directory:</p>
            <p style="text-indent: 2.0em; border-color: #000;"><tt>python -m SimpleHTTPServer [&lt;port&gt;]</tt></p>
            <p>Now, point your browser at</p>
            <p style="text-indent: 2.0em; border-color: #000;"><tt>http://&lt;hostIP&gt;[:&lt;port&gt;]</tt></p>
            <h4>Login</h4>
            <p>On the top left of the control panel is the login status toggle button. On first run, this should say "login status: logged out". Simply hit the button and wait for the status to change to "logged in". Login never expires, only when you explicitly hit "logout". </p>
            <h4>DB Permancy</h4>
            <p>
                If you wish to have consistency in the data space between calls to the API, you need to store the data DB to disk. Make sure that the "Use file DB" button reads "ON" and is green.
            </p>
            <p>
                Toggle the "Create new DB" button to "ON" if you want to create a new DB. Note, this will overwrite/delete any previous DB tree at that file location.
            </p>
            <h4>Call</h4>
            <p>Once logged in for the first time, or on each time this page is visited, hit the <tt>Call</tt> button to call the current URL (shown in the <i>URLs available</i> select box). With each call of a URL, the contents of this box will change. Simply keep choosing URLs as they are made available to explore the data space.</p>
            <h4>JSON syntax highlight</h4>
            <p>By default, the JSON syntax highlight is ON. Hitting the button on the top left will toggle this state. The OFF state is best for viewing error returns from the API because error messages from the python backend run across multiple lines. The syntax highlight ON would show a multi-line return as one long line with a scroll bar.</p>
            <h4>Operation</h4>
            <p>For the most, interacting with the ChRIS REST Web Service API requires no "input" from the user, other than perhaps manually specifying the ChRIS web service IP and port.</p>
            <p>Each call to the ChRIS API returns a description of available URL actions that can be accessed, dependent on the current call. In this manner, software agents can self-discover the data/action space exposed by the ChRIS REST API.</p>
        </div>
        <form class="pure-form pure-form-aligned">
            <fieldset>
                <legend>REST Call Detail</legend>

                <div class="pure-control-group">
                    <label>Server IP:port</label>
                    <input style="width:60px;font-family:courier;" type="text" maxlength="3" class="onlythree" id="IP1" value="127"/>.
                    <input style="width:60px;font-family:courier;" type="text" maxlength="3" class="onlythree" id="IP2" value="0"/>.
                    <input style="width:60px;font-family:courier;" type="text" maxlength="3" class="onlythree" id="IP3" value="0"/>.
                    <input style="width:60px;font-family:courier;" type="text" maxlength="3" class="onlythree" id="IP4" value="1"/>:
                    <input style="width:70px;font-family:courier;" type="text" id="port" value="5555"/>
                </div>
                <div class="pure-control-group">
                    <label>DB</label>
                    <input style="width:595px;font-family:courier;" id="DB" name="DB" value="/tmp/ChRIS_DB"><br>
                </div>
                <div class="pure-control-group">
                    <label>PUSH VERB</label>
                    <select id="VERB" class="pure-input-4-24">
                        <!--<option>GET</option>-->
                        <option>POST</option>
                        <option>PUT</option>
                        <!--<option>DELETE</option>-->
                    </select>
                    <label>API version</label>
                    <select id="version" class="pure-input-4-24">
                        <option>v1</option>
                    </select>
                    <label>Feed Key</label>
                    <select id="key" class="pure-input-4-24">
                        <option>NAME</option>
                        <option>ID</option>
                    </select>
                </div>
                <div class="pure-control-group">
                    <label for="URLsFromChRIS">
                        <button onclick="return REST_call()" style="float: right;" class="pure-button pure-button-primary">GET</button>
                    </label>
                    <select class="pure-input-1-2" id="URLsFromChRIS" style="width:595px;">
                    </select>
                </div>
                <div class="pure-control-group" id="dom_PUSH" style="display:none">
                </div>
                <div class="pure-control-group">
                    <label>AUTH</label>
                    <input style="width:595px;font-family:courier;" id="AUTH" name="AUTH" value="auth=user=chris,hash=ABCDEF123456789"><br>
                </div>

                <button onclick="window.location.reload(true)" class="pure-button pure-button-primary button-reset">Reset</button>

            </fieldset>
        </form>
    </div>

    <div class="resultLayout" id="result">
    </div>

    <div class="modal"><!-- Place at bottom of page --></div>

    <script>
    // ---------------------------------------------------------------------------------------------------------------
    // ---------------------------------------------------------------------------------------------------------------

    // Some "global" variables.

    // The whole document
    $body                       = $("body");
    // Some specific parts of the document -- in a proper design these would be members
    // of a class. To indicate the more global scope, these are all prepended with an 'm'
    // for 'member'. ** Not implemented yet **
    result_DOM                  = document.getElementById("result");
    PUSH_DOM                    = document.getElementById("dom_PUSH");
    URLsFromChRIS_DOM           = $('#URLsFromChRIS');
    d_URLsFromChRIS             = null;
    key_DOM                     = $('#key');
    // API call return strings
    APIcall                     = '';
    json_ChRISresp              = '';
    // Some default/persistent URL select options.
    str_pathUp                  = '';
    str_allFeedsBase            = '';
    str_loginFile               = '';
    b_URLsBuild                 = true;
    b_jsonSyntaxHighlight       = true;
    b_useFileDB_status          = true;
    b_createNewDB_status        = false;
    b_loginStatus               = false;
    b_canPUSH                   = false;            // Toggles PUSH display
    b_PUSHchoicesRendered       = false;
    functionCallDepth           = 0;

    $(document).on({
        ajaxStart:  function() { $body.addClass("loading");  output(APIcall);  },
        ajaxStop:   function() { $body.removeClass("loading"); }
    });

    $( "#helpInfo" ).dialog({
        autoOpen:       false,
        height:         520,
        width:          500,
        dialogClass:    'helpInfo-dialog'
    });
    $( "#opener" ).click(function() {
        $( "#helpInfo" ).dialog( "open" );
    });

    $(".onlythree").keyup(function () {    
        if (this.value.length == this.maxLength) {    
            $(this).next('.onlythree').focus();    
        }    
    });

    function jsonSyntaxHightlight_toggle() {
        JSON_syntaxButton_DOM = document.getElementById("JSON_status");
        console.log('\nIn JSON_syntaxHighlight... b_SyntaxHighlight before toggle = ' + b_jsonSyntaxHighlight);
        b_jsonSyntaxHighlight = !b_jsonSyntaxHighlight;
        console.log('In JSON_syntaxHighlight... b_SyntaxHighlight after  toggle = ' + b_jsonSyntaxHighlight);
        if(b_jsonSyntaxHighlight) {
            JSON_syntaxButton_DOM.innerHTML     = 'JSON syntax highlight: ON';
            JSON_syntaxButton_DOM.className     = 'button-xsmall pure-button pure-button-primary button-jsonHighlight-on';
        }
        if(!b_jsonSyntaxHighlight) {
            JSON_syntaxButton_DOM.innerHTML     = 'JSON syntax highlight: OFF';
            JSON_syntaxButton_DOM.className     = 'button-xsmall pure-button pure-button-primary button-jsonHighlight-off';
        }
    }

    function useFileDB_toggle() {
        fileDB_status_DOM = document.getElementById("useFileDB_status");
        console.log('\nIn useFileDB_toggle... b_useFileDB_status before toggle = ' + b_useFileDB_status);
        b_useFileDB_status = !b_useFileDB_status;
        console.log('In useFileDB_toggle... b_useFileDB_status after toggle  = ' + b_useFileDB_status);
        if(b_useFileDB_status) {
            fileDB_status_DOM.innerHTML     = 'Use file DB: ON';
            fileDB_status_DOM.className     = 'button-xsmall pure-button pure-button-primary button-useFileDB-on';
        }
        if(!b_useFileDB_status) {
            fileDB_status_DOM.innerHTML     = 'Use file DB: OFF';
            fileDB_status_DOM.className     = 'button-xsmall pure-button pure-button-primary button-useFileDB-off';
        }
    }

    function createNewDB_toggle() {
        fileDB_status_DOM = document.getElementById("createNewDB_status");
        console.log('\nIn createNewDB_toggle... b_createNewDB_status before toggle = ' + b_createNewDB_status);
        b_createNewDB_status = !b_createNewDB_status;
        console.log('In createNewDB_toggle... b_createNewDB_status after toggle  = ' + b_createNewDB_status);
        if(b_createNewDB_status) {
            fileDB_status_DOM.innerHTML     = 'Create new DB: ON';
            fileDB_status_DOM.className     = 'button-xsmall pure-button pure-button-primary button-createNewDB-on';
        }
        if(!b_createNewDB_status) {
            fileDB_status_DOM.innerHTML     = 'Create new DB: OFF';
            fileDB_status_DOM.className     = 'button-xsmall pure-button pure-button-primary button-createNewDB-off';
        }
    }

    function loginStatus_toggle() {
        var debug           = new C_debug();
        debug.functionName  = "loginStatus_toggle";
        debug.entering();
        b_loginStatus   = !b_loginStatus;
        debug.vlog({message: 'b_loginStatus', var: b_loginStatus});
        if(b_loginStatus) {
            login();
        } else {
            logout();
        }
        debug.leaving();
    }

    function file_exist(str_filename) {
        var http = new XMLHttpRequest();
        http.open('HEAD', str_filename, false);
        http.send();
        return http.status!=404;
    }

    function loginStatus_show(ab_status) {
        var debug           = new C_debug();
        debug.functionName  = "loginStatus_show";
        debug.entering();
        loginStatus_DOM = document.getElementById("loginStatus");
        debug.vlog({message: 'ab_status', var: ab_status});
        b_loginStatus = ab_status;
        if(ab_status) {
            loginStatus_DOM.innerHTML           = 'login status: logged in';
            loginStatus_DOM.className           = 'button-xsmall button-loginStatus-loggedIn pure-button';
        } else {
            loginStatus_DOM.innerHTML           = 'login status: logged out';
            loginStatus_DOM.className           = 'button-xsmall button-loginStatus-loggedOut pure-button';
        }
        debug.leaving();
    }

    function loginStatus_fileTagGenerate() {
        serverAddress       = window.location.href;
        l_p = serverAddress.split('/');
        str_loginFile       = 'chris-login.json';
        l_p[l_p.length - 1] = str_loginFile;
        str_loginURLtag     = l_p.join('/');
    }

    function login() {
        d_APIcall = {
            'type':             'GET',
            'APIcallOverride':  '/v1/login?auth=user=chris,passwd=chris1234',
            'showOutput':       true,
            'data':             ''
        };
        REST_call(d_APIcall);
        loginStatus_show(file_exist(str_loginURLtag));
        b_URLsBuild = false;
    }

    function logout() {
        d_APIcall = {
            'type':             'GET',
            'APIcallOverride':  '/v1/logout?auth=user=chris,auth=ABCDEF',
            'showOutput':       true,
            'data':             ''
        };
        REST_call(d_APIcall);
        loginStatus_show(file_exist(str_loginURLtag));
        b_URLsBuild = false;
    }

    window.onload = function() {
        loginStatus_fileTagGenerate();
        loginStatus_show(file_exist(str_loginURLtag));
    };

    function URLsFromChRIS_build(json_ChRISresp) {
        /*
        This function parses the URL component of the response to
        build a list of possible navigable links from this
        point in the dataspace.

        ARGS
            json_ChRISresp  json-object     the response from ChRIS

        */
        var debug           = new C_debug();
        debug.functionName  = "URLsFromChRIS_build";
        debug.entering();

        URLsFromChRIS_DOM.empty();
        d_URLsFromChRIS = json_ChRISresp.return.URL_get.slice();
        // First, build a breadcrumb path back through the dataspace
        if (str_pathUp.length) {
            str_path    = json_ChRISresp.return.path;
            debug.vlog({message: 'str_path', var: str_path});
            l_path      = str_path.split('/');
            // Get rid of the trailing '/' if it exists.
            if(!l_path[l_path.length-1].length) l_path.pop();
            for(d=l_path.length-1; d>=0; d--) {
                l_breadCrumb    = l_path.slice(0, d+1);
                str_breadCrumb  = l_breadCrumb.join('/');
                str_pathUp      = str_allFeedsBase + '_' + str_breadCrumb;
                if (str_pathUp == 'Feeds/' + key_DOM.val() + '_') {
                    console.log('cleaning!!');
                    str_pathUp = 'Feeds/' + key_DOM.val();
                }

                d_URLsFromChRIS.push(str_pathUp);
            }
            // Push the root URL
            d_URLsFromChRIS.push('Feeds/' + key_DOM.val());
        }
        // Now build the URLs from this point *forward* in the datatree space
        // as returned by ChRIS
        $.each(d_URLsFromChRIS, function (key, val) {
            if (!str_pathUp.length) {
                str_allFeedsBase    = 'Feeds/' + key_DOM.val();
                str_pathUp          = str_allFeedsBase + '_' + json_ChRISresp.return.path;
            }
            URLsFromChRIS_DOM.append(
                    $('<option></option>').val(key).html(val)
            );
        });
        debug.leaving()
    }

    function output(inp) {
        result_DOM.innerHTML = "<pre>" + inp + "</pre>";
    }

    function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function API_assemblePrefix() {
        /*
            Assembles the first part of the URL access string to the remote
            server, typically:

                http://<IP>[:<port>]
        */

        // Assemble the service address and port:
        var IP1	= $('#IP1').val();
        var IP2	= $('#IP2').val();
        var IP3	= $('#IP3').val();
        var IP4	= $('#IP4').val();
        var str_hostIP  = "http://" + IP1 + "." + IP2 + "." + IP3 + "." + IP4;
        var str_FQhost  = str_hostIP + ":" + $("#port").val();

        return(str_FQhost);

    }

    function API_assembleCore(d_APIcall) {
        /*
        Assembles the main URL call from various subcomponents.
         */
        var debug           = new C_debug();
        debug.functionName  = "API_assembleCore";
        debug.entering();
        debug.vlog({message: 'd_APIcall', var: d_APIcall});

        if( typeof(d_APIcall['APIcallOverride'])==='undefined' || typeof(d_APIcall['URL']) === 'string') {
            str_URLsFromChRIS_selected  = URLsFromChRIS_DOM.val();
            if(typeof(str_URLsFromChRIS_selected)==="object") {
                APIcall                 = '/'               +
                        $('#version').val()                 +
                        '/Feeds/'   + key_DOM.val()         +
                        "?" + $('#AUTH').val();
            } else {
                URLsFromChRIS_selected  = parseInt(str_URLsFromChRIS_selected);
                // Remember, the d_URLsFromChRIS has been appended to by the URLsFromChRIS_build() method.
                if(typeof(d_APIcall['URL'])==='undefined') {
                    str_URL = d_URLsFromChRIS[URLsFromChRIS_selected];
                } else {
                    str_URL = d_APIcall['URL'];
                }
                APIcall                 = '/' +
                        $('#version').val()  + '/'          +
                        str_URL                             +
                        "?" + $('#AUTH').val();
            }
        } else {
            APIcall = d_APIcall['APIcallOverride'];
        }
        debug.vlog({message: 'APIcall', var: APIcall})
        debug.leaving();
        return(APIcall);
    }

    function API_assembleSuffix() {
        /*
        Assembles the "suffix" call, typically things like DB access.
        */

        var APIsuffix   = "";
        DBpath_DOM          = document.getElementById("DB");
        DBpath              = $('#DB');

        if(b_createNewDB_status) {
            APIsuffix   = "&createNewDB=1";
        }
        if(DBpath_DOM.value.length) {
            APIsuffix   = APIsuffix + "&DBpath="   + DBpath_DOM.value;
        }
        return(APIsuffix);
    }

    function API_assemble(d_APIcall) {
        /*
        Builds the API from prefix, core, suffix components.
        */
        str_APIcall = API_assemblePrefix()
                    + API_assembleCore(d_APIcall)
                    + API_assembleSuffix();

        return(str_APIcall);
    }

    /**
     * @return {boolean}
     */
    function RESTobject_detected() {
        /*
        Determines if a REST object is in a delta region about
        the current focus in the server data space.

        The data location is defined by the pattern of URLs returned
        by the server, given a position in the data space.
        */

        var debug           = new C_debug();
        debug.functionName  = "RESTobject_detected";
        debug.entering();

        b_canPUSH   = false;
//        URLsFromChRIS_build(json_ChRISresp);
        debug.vlog({message: 'd_URLsFromChRIS', var: d_URLsFromChRIS});
        if(d_URLsFromChRIS != null) {
            debug.log({message: 'Processing d_URLsFromChRIS...'});
            d_URLsFromChRIS.filter(function (el) {
                debug.vlog({message: 'el', var: el});
                if (el.indexOf('REST') >= 0) {
                    b_canPUSH   = true;
                }
            });
        }
        debug.vlog({message: 'b_canPUSH', var: b_canPUSH});
        debug.leaving();
        return b_canPUSH;
    }

    function callback_AJAX_success(ChRISresp, d_APIcall) {
        /*
        This is an asynchronous function, so when you hit a button in REST_call, state of
        available URLs etc are NOT updated until this function is called.
        */


        var debug           = new C_debug();
        debug.functionName  = "callback_AJAX_success";
        debug.entering();

        ChRISresp           = JSON.stringify(ChRISresp, null, 2);
        json_ChRISresp      = JSON.parse(ChRISresp);

        debug.vlog({'message': 'json_ChRISresp', var: json_ChRISresp});
        debug.vlog({'message': 'd_APIcall', var: d_APIcall});
        if(!b_URLsBuild)
            b_URLsBuild = true;
        else
            if(b_loginStatus) {
                URLsFromChRIS_build(json_ChRISresp);
                if(d_APIcall['branchOnREST']) {
                    if(RESTobject_detected()) PUSH_choicesParse();
            }
        }
        debug.vlog({message: 'showOutput', var: d_APIcall.showOutput});
        if(d_APIcall['showOutput']) {
            if (b_jsonSyntaxHighlight)
                output(syntaxHighlight(ChRISresp));
            else
                output((ChRISresp));
            loginStatus_show(file_exist(str_loginURLtag));
        }
        if(RESTobject_detected()) {
            PUSH_DOM.style.display  = "block";
        } else {
            PUSH_DOM.style.display  = "none";
            PUSH_DOM.innerHTML      = "";
            b_PUSHchoicesRendered   = false;
        }
        debug.vlog({message: 'b_canPUSH', var: b_canPUSH});
        debug.leaving();
    }

    function callback_AJAX_error(xhdr, textStatus, thrownError) {
        hdr                 = null;
        console.log('Some error was triggered.');
        console.log('textStatus         = ' +  textStatus);
        console.log('xhdr.statusText    = ' +  xhdr.statusText);
        console.log('xhdr.responseText  = ' +  xhdr.responseText);
        console.log('xhdr.status        = ' +  xhdr.status);
        console.log('thrownError        = ' +  thrownError);
        var str = JSON.stringify(xhdr.responseText, null, 2);
        output(syntaxHighlight(xhdr.status));
        hdr=xhdr;
    }

    function REST_call(d_APIcall) {
        /*
            The main entry point to calling the service. The specific arguments
            to pass to the back end service are typically parsed from the HTML
            content; however if <APIcallOverride> is defined, then this will be
            passed instead. This is useful for specific "canned" calls, i.e.
            the login and logout calls -- the login() and logout() functions
            above.

            ARGS

                d_APICall           dictionary

                    'type':         'GET'|'PUT'     -- the type of call
                    'override':     string          -- an override call

                if not passed, will default to GET and void override

         */
        var debug           = new C_debug();
        debug.functionName  = "REST_call";
        debug.cl();
        debug.entering();

        ChRISresp           = null;

        loginStatus_fileTagGenerate();

        if(typeof(d_APIcall)==='undefined') {
            d_APIcall                   = {};
            d_APIcall['type']           = 'GET';
            d_APIcall['showOutput']     = true;
            d_APIcall['branchOnREST']   = true;
            d_APIcall['data']           = '';
        }

        APIcall             = API_assemble(d_APIcall);
        debug.vlog({message: 'APIcall',     var: APIcall} );
        debug.vlog({message: 'd_APIcall',   var: d_APIcall});

        $.ajax({
            url:        APIcall,
            type:       d_APIcall['type'],
            dataType:   'json',
            data:       d_APIcall['data'],
            success:    function(ChRISresp) {
                callback_AJAX_success(ChRISresp, d_APIcall);
            },
            error: callback_AJAX_error
        });
        debug.leaving();
        debug.cl();
        return false; //stop the form from initially submitting
    }

    function PUSH_choicesParse(aURL) {
        /*
        Build the dialog box for the PUSH choices, as parsed from the
        REST token returned from the server. This actually performs a
        hidden GET to parse the REST PUSH object.

        ARGS
            aURL        string      the location of the REST token in the
                                    server data tree.
         */

        var debug           = new C_debug();
        debug.functionName  = "PUSH_choicesParse";
        debug.entering();
        debug.vlog( {message: 'aURL', var: aURL} );

        d_APIcall                   = {};
        d_APIcall['type']           = 'GET';
        d_APIcall['showOutput']     = false;
        d_APIcall['URL']            = aURL;
        d_APIcall['branchOnREST']   = false;
        d_APIcall['data']           = '';

        debug.vlog( {message: 'd_APIcall', var: d_APIcall} );

        REST_call(d_APIcall);
        d_choice = json_ChRISresp.return.payload;

        debug.vlog( {message: 'd_choice', var: d_choice});
        debug.vlog( {message: 'd_choice.keys()', var: Object.keys(d_choice)});

        l_keysPayload   = Object.keys(d_choice);
        l_keysPayload.filter(function (el) {
            if (el != "meta") {
                d_container = d_choice[el];
                debug.vlog({message: 'd_container', var: d_container});
                if (!(typeof(d_container) === 'string')) {
                    if(!(typeof(d_container.REST) === 'undefined')) {
                        if (typeof(d_container.REST.PUSH) === 'object') {
                            d_PUSH = d_container.REST.PUSH;
                            debug.vlog({message: 'REST options', var: d_PUSH});
                            PUSH_choicesBuild(d_PUSH, d_APIcall);
                        }
                    }
                }
            }
        });
        debug.leaving();
    }

    function PUSH_choicesBuild(d_PUSH, d_APIcall) {
        /*
        "Build" the actual PUSH choices dialog boxes, based on the passed dictionary.

        Dictionary typically has components like:

            {
                "body":     "string",
                "weight":   "int"
            }

        which is rendered as:

            [PUSH]   [body] [string] [<...... text input box .........>]
            [PUSH]   [weight] [int]  [<...... text input box .........>]
        */
        var debug           = new C_debug();
        debug.functionName  = "PUSH_choicesBuild";
        debug.entering();
        debug.vlog( {message: 'd_PUSH', var: d_PUSH});
        l_keys = Object.keys(d_PUSH);
        debug.vlog( {message: 'l_keys', var: l_keys});
        if(!b_PUSHchoicesRendered) {
            l_keys.forEach(function (key) {
                debug.vlog({message: 'key/type', var: [key, d_PUSH[key]]});
                str_element     = 'PUSH_' + key;

                // Get the contents for each push element
                l_URL           = json_ChRISresp.return.URL_get;
                b_textarea_mk   = false;
                rows            = 5;
                l_URL.forEach(function (url) {
                    if(url.indexOf(key) >= 0) {
                        str_pathToObject    = json_ChRISresp.return.path;
                        str_endNode         = str_pathToObject.split('/').slice(-1)[0];
                        str_endNodeParent   = str_pathToObject.split('/').slice(-2, -1)[0];
                        debug.vlog({message: 'str_endNodeParent',   var: str_endNodeParent});
                        debug.vlog({message: 'str_endNode',         var: str_endNode});
                        str_contents        = '';
                        if(str_endNode == key) {
                            debug.vlog({message: 'typeof(json_ChRISresp.return.payload[key])', var: typeof(json_ChRISresp.return.payload[key])})
                            if(typeof(json_ChRISresp.return.payload[key])==='string') {
                                debug.vlog({message: 'pathInObject -- return.payload + ', var: key});
                                str_contents = json_ChRISresp.return.payload[key];
                            }
                        } else {
                            debug.vlog({message: 'typeof(json_ChRISresp.return.payload[str_endNode][key])', var: typeof(json_ChRISresp.return.payload[str_endNode][key])})
                            if(typeof(json_ChRISresp.return.payload[str_endNode][key])==='string') {
                                debug.vlog({message: 'pathInObject -- return.payload.' + str_endNode + ' + ', var: key});
                                str_contents = json_ChRISresp.return.payload[str_endNode][key];
                            }
                        }
                        debug.vlog({message: 'str_contents for ' + key, var: str_contents});
                        if(str_contents.length > 52) {
                            b_textarea_mk   = true;
                            rows            = str_contents.length / 52 + 1;
                        }
                        debug.vlog({message: 'str_contents.length: ' + str_contents.length + ',b_textarea_mk', var: b_textarea_mk});
                        debug.vlog({message: 'rows', var: rows});
                    }
                });

                // Build the push element components
                str_innerHTML   = ' '   +
                        '<label>'       +
                            '<button onclick="return PUSH_choicesRead(\'' + key + '\', \'post\')" style="float: right;" class="pure-button pure-button-primary">PUSH ' + key + '</button>' +
                        '</label>'      +
                        '<span>'        +
                            '<button onclick="return PUSH_choicesRead(\'' + key + '\', \'del\')" style="float: right;" class="button-REST-delete pure-button pure-button-primary"><i class="fa fa-trash fa-1x"></i></button>' +
                            '<button onclick="return PUSH_choicesRead(\'' + key + '\', \'run\')" style="float: right;" class="button-REST-run pure-button pure-button-primary"><i class="fa fa-gear fa-1x"></i></button>';
                if(b_textarea_mk) {
                    str_innerHTML = str_innerHTML   +
                            ' <textarea rows="' + rows + '" style="width:590px;font-family:courier;" id="PUSH_' + key + '" name="PUSH_' + key + '" value=""></textarea><br>';
                } else {
                    str_innerHTML = str_innerHTML   +
                            ' <input style="width:590px;font-family:courier;" id="PUSH_' + key + '" name="PUSH_' + key + '" value=""><br>';
                }
                str_innerHTML   = str_innerHTML     +
                        '</span>';
                debug.vlog({message: 'str_innerHTML', var: str_innerHTML});
                $("#dom_PUSH").append(str_innerHTML);

                PUSH_choice_DOM         = document.getElementById(str_element);
                debug.vlog({message: 'json_ChRISresp', var: json_ChRISresp});

                // And not place the contents into the locations in the HTML elements.
                l_URL.forEach(function (url) {
                    if(url.indexOf(key) >= 0) {
                        PUSH_choice_DOM.value = str_contents;
                    }
                });
            });
        }
        b_PUSHchoicesRendered   = true;
        debug.vlog({message: 'd_APIcall', var: d_APIcall});
        debug.leaving();
    }

    function PUSH_choicesRead(key, action) {
        /*
         Read the input field and execute the REST call.

         ARGS
            key        string          key to access DOM element
            type       string          type of PUSH
         */
        var debug           = new C_debug();
        debug.functionName  = "PUSH_choicesRead";
        debug.entering();

        debug.vlog({message: 'key',     var: key});
        debug.vlog({message: 'action',  var: action});
        str_element         = 'PUSH_' + key;
        PUSH_choice_DOM     = document.getElementById(str_element);
        console.log(PUSH_choice_DOM);

        str_value           = PUSH_choice_DOM.value;
        debug.vlog({message: 'PUSH payload', var: str_value});

        str_RESTcallType    = VERB.value;
        VERB                = document.getElementById('VERB')
        debug.vlog({message: 'VERB.value', var: str_RESTcallType});

        d_data                              = {};
        d_data[str_RESTcallType]            = {};
        d_data[str_RESTcallType][key]       = str_value;
        d_data[str_RESTcallType]['action']  = action;
        debug.vlog({message: 'd_data',      var: d_data});
        debug.vlog({message: 'd_APIcall',   var: d_APIcall});

        d_APIcall   = {
            'type':             str_RESTcallType,
            'showOutput':       true,
            'data':             JSON.stringify(d_data),
            'action':           action
        };

        debug.vlog({message: 'd_APIcall',   var: d_APIcall});

        debug.leaving();

        return REST_call(d_APIcall);
    }


    function C_debug(d) {
        /*
        Print some debugging info to console.

        d.functionName      string      name of function
        d.message           string      message
        d.var               var         variable to print
        */

        this.functionName   = '<void>';
        this.message        = '<void>';
        this.var            = null;
        this.tab            = 0;

        if(!(typeof(d)==='undefined')) {
            this.functionName   = d.functionName;
            this.message        = d.message;
            this.var            = d.var;
        }

        this.cl  = function() {
            console.log(' ');
        };

        this.indent     = function() {
            str_indent  = '';
            for(i=0; i<this.tab; i++)
                str_indent = str_indent + '\t';
            return str_indent;
        };

        this.entering   = function() {
            functionCallDepth += 1;
            this.tab = functionCallDepth;
            console.log(this.indent() +  '--------> Entering ' + this.functionName + '...');
        };

        this.leaving    = function() {
            console.log(this.indent() +  'Leaving ' + this.functionName + ' --------> ');
            functionCallDepth -= 1;
        };

        this.vlog       = function(d) {
            if(typeof(d.functionName)!='undefined') this.functionName   = d.functionName;
            this.message        = d.message;
            this.var            = d.var;
            if(typeof(this.var)==='object') {
                console.log(this.indent() + 'In ' + this.functionName + ': ' + d.message + ' = ');
                console.log(d.var);
            } else
                console.log(this.indent() + 'In ' + this.functionName + ': ' + d.message + ' = ' + d.var);
        };

        this.log = function(d) {
            if(typeof(d.functionName)!='undefined') this.functionName   = d.functionName;
            this.message        = d.message;
            console.log(this.indent() + 'In ' + this.functionName + ': ' + d.message);
        };

    }

    </script>

</body>
</html>
